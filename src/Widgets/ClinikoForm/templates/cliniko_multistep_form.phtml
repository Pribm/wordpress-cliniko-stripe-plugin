<?php

use App\Admin\Modules\Credentials;
use App\Model\AppointmentType;
use App\Exception\ApiException;
use App\Model\PatientFormTemplate;

if (!defined('ABSPATH')) exit;

function hex2rgb($hex)
{
  $hex = str_replace('#', '', $hex);
  if (strlen($hex) === 3) {
    $r = hexdec(str_repeat($hex[0], 2));
    $g = hexdec(str_repeat($hex[1], 2));
    $b = hexdec(str_repeat($hex[2], 2));
  } else {
    $r = hexdec(substr($hex, 0, 2));
    $g = hexdec(substr($hex, 2, 2));
    $b = hexdec(substr($hex, 4, 2));
  }
  return "$r, $g, $b";
}

$settings = $this->get_settings();
$form_template_id = $settings['cliniko_form_template_id'] ?? null;

// ---------- Resolve Appointment Type / Practitioner IDs ----------
$appointmentType = null;
try {
  $appointmentType = AppointmentType::find($settings["module_id"] ?? null, cliniko_client(true));
} catch (\Throwable $e) {
  // allow rendering without IDs; embed step will be skipped if not configured
}

$practitionerID   = null;
$appointmentTypeID= null;

if ($appointmentType) {
  $practitioners = $appointmentType->getPractitioners();
  if (!empty($practitioners) && isset($practitioners[0])) {
    $practitionerID = $practitioners[0]->getId();
  }
  $appointmentTypeID = $appointmentType->getId();
}

if (empty($form_template_id)) {
  echo '<p style="color: red;">No sections found in the Cliniko form template.</p>';
  return;
}

try {
  $template = PatientFormTemplate::find($form_template_id, cliniko_client(true));
  $sections = $template ? $template->getSections() : [];
} catch (\Throwable $e) {
  throw new ApiException($e->getMessage());
}

if (empty($sections)) {
  echo '<p style="color: red;">No sections found in the Cliniko form template.</p>';
  return;
}

// ---------- UI Settings ----------
$bg           = esc_attr($settings['form_background_color'] ?? '#ffffff');
$text         = esc_attr($settings['form_text_color'] ?? '#000000');
$font         = esc_attr($settings['form_font_family'] ?? 'Arial, sans-serif');
$label        = esc_attr($settings['form_label_color'] ?? '#333333');
$input_border = esc_attr($settings['form_input_border'] ?? '1px solid #ccc');
$border_radius= esc_attr(($settings['form_border_radius']['size'] ?? 6) . ($settings['form_border_radius']['unit'] ?? 'px'));

$titles_color = esc_attr($settings['titles_color'] ?? '#000000');
$btn_bg       = esc_attr($settings['form_button_color'] ?? '#0073e6');
$btn_text     = esc_attr($settings['form_button_text_color'] ?? '#ffffff');
$btn_bg_rgb   = hex2rgb($btn_bg);

$pad     = $settings['form_button_padding'] ?? null;
$btn_pad = isset($pad['top'], $pad['right'], $pad['bottom'], $pad['left'], $pad['unit'])
  ? "{$pad['top']}{$pad['unit']} {$pad['right']}{$pad['unit']} {$pad['bottom']}{$pad['unit']} {$pad['left']}{$pad['unit']}"
  : '12px 24px';

$radius        = esc_attr(($settings['form_button_border_radius']['size'] ?? 6) . ($settings['form_button_border_radius']['unit'] ?? 'px'));
$layout        = $settings['form_button_layout'] ?? 'stacked';
$width         = $settings['form_button_width'] ?? 'full';
$alignment     = $settings['form_button_alignment'] ?? 'center';
$icon_prev     = $settings['form_button_icon_prev']['value'] ?? '';
$icon_next     = $settings['form_button_icon_next']['value'] ?? '';
$icon_position = $settings['form_button_icon_position'] ?? 'before';
$icon_spacing  = isset($settings['form_button_icon_spacing']['size']) ? $settings['form_button_icon_spacing']['size'] . 'px' : '8px';

$container_flex_direction = $layout === 'row' ? 'row' : 'column';

$justify_content = match ($alignment) {
  'start' => 'flex-start',
  'center' => 'center',
  'end' => 'flex-end',
  'space-between' => 'space-between',
  default => 'center',
};
$button_flex = $width === 'full' ? '1 1 100%' : '0 0 auto';

// ---------- Assets (versioned) ----------
$base_url   = trailingslashit(plugin_dir_url(dirname(__FILE__)));  // .../ClinikoForm/
$assets_url = $base_url . 'assets/';

$base_path = trailingslashit(plugin_dir_path(dirname(__FILE__)));
$js_ver    = file_exists($base_path . 'assets/js/input-masks.js') ? filemtime($base_path . 'assets/js/input-masks.js') : null;
$css_ver   = file_exists($base_path . 'assets/css/multistep-form-style.css') ? filemtime($base_path . 'assets/css/multistep-form-style.css') : null;

// ---------- Embed setup (only if configured) ----------
$useClinikoEmbed = (($settings['appointment_source'] ?? '') === 'cliniko_embed');
$embedHost       = Credentials::getEmbedHost();
$businessId      = get_option('wp_cliniko_business_id');

// Require all pieces to render the embed step
$hasEmbedStep    = $useClinikoEmbed && $embedHost && $businessId && $practitionerID && $appointmentTypeID;

$embedSrc = null;
if ($hasEmbedStep) {
  $embedParams = http_build_query([
    'business_id'         => $businessId,
    'practitioner_id'     => $practitionerID,
    'appointment_type_id' => $appointmentTypeID,
    'embedded'            => 'true',
  ]);
  $embedSrc = sprintf('https://%s/bookings?%s', $embedHost, $embedParams);
}

// ---------- Step Indexing ----------
// Order: [all template sections] -> [Patient step] -> [optional Cliniko embed step]
$numSectionSteps   = count($sections);
$patientStepIndex  = $numSectionSteps;
$embedStepIndex    = $patientStepIndex + 1;
$totalSteps        = $numSectionSteps + 1 + ($hasEmbedStep ? 1 : 0);
$currentStep       = 1; // your JS can update this as the user navigates

?>
<!-- ðŸ§  Inject CSS Variables -->
<style>
  #prepayment-form {
    --form-bg: <?= $bg ?>;
    --form-text: <?= $text ?>;
    --form-font: <?= $font ?>;
    --form-label: <?= $label ?>;
    --form-input-border: <?= $input_border ?>;
    --form-radius: <?= $border_radius ?>;

    --titles-color: <?= $titles_color ?>;
    --btn-bg: <?= $btn_bg ?>;
    --btn-bg-rgb: <?= $btn_bg_rgb ?>;
    --btn-text: <?= $btn_text ?>;
    --btn-pad: <?= $btn_pad ?>;
    --btn-radius: <?= $radius ?>;
    --btn-flex: <?= $button_flex ?>;
    --btn-icon-gap: <?= $icon_spacing ?>;
  }

  .other-input-wrap { margin: 6px 0 0 28px; }
</style>

<!-- External Libraries -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://unpkg.com/imask"></script>

<!-- Versioned assets -->
<script src="<?= esc_url($assets_url . 'js/input-masks.js' . ($js_ver ? '?ver=' . $js_ver : '')) ?>"></script>
<link rel="stylesheet" href="<?= esc_url($assets_url . 'css/multistep-form-style.css' . ($css_ver ? '?ver=' . $css_ver : '')) ?>">

<!-- Multistep Form -->
<form id="prepayment-form">
  <!-- Progress -->
  <?php $progressType = $settings['progress_type'] ?? 'bar'; ?>
  <div id="form-progress-indicator" class="form-progress form-progress--<?= esc_attr($progressType) ?>">
    <?php if ($progressType === 'bar'): ?>
      <div class="progress-track">
        <div class="progress-fill" style="width: <?= ($totalSteps > 0 ? ($currentStep / $totalSteps) * 100 : 0) ?>%;"></div>
      </div>
    <?php elseif ($progressType === 'dots'): ?>
      <?php for ($i = 1; $i <= $totalSteps; $i++): ?>
        <span class="progress-dot <?= $i === $currentStep ? 'is-active' : '' ?>"></span>
      <?php endfor; ?>
    <?php elseif ($progressType === 'steps'): ?>
      <?php for ($i = 1; $i <= $totalSteps; $i++): ?>
        <?php if ($i > 1): ?><div class="form-progress__divider"></div><?php endif; ?>
        <div class="progress-step <?= $i === $currentStep ? 'is-active' : '' ?>"><?= $i ?></div>
      <?php endfor; ?>
    <?php elseif ($progressType === 'fraction'): ?>
      <span class="progress-text"><?= $currentStep ?>/<?= $totalSteps ?></span>
    <?php elseif ($progressType === 'percentage'): ?>
      <span class="progress-text"><?= $totalSteps > 0 ? round(($currentStep / $totalSteps) * 100) : 0 ?>%</span>
    <?php endif; ?>
  </div>

  <div id="cliniko-form-steps">

    <!-- Template Sections -->
    <?php foreach ($sections as $index => $section): ?>
      <div class="form-step <?= $index > 0 ? 'is-hidden' : '' ?>" data-step="<?= (int)$index ?>">
        <h3 class="multi-form-title-color"><?= esc_html($section->name) ?></h3>
        <?php if (!empty($section->description)): ?>
          <p class="multi-form-title-color"><?= wp_kses_post($section->description) ?></p>
        <?php endif; ?>

        <?php foreach ($section->questions as $question): ?>
          <?php
          $input_name  = esc_attr($question->name);
          $required    = !empty($question->required) ? 'required' : '';
          $is_required = !empty($question->required);
          $qid         = substr(md5($input_name), 0, 8);
          ?>
          <div class="inputGroup">
            <h4 class="question-title">
              <?= esc_html($question->name) ?> <?php if ($is_required): ?><span class="req">*</span><?php endif; ?>
            </h4>

            <?php switch ($question->type):
              case 'paragraph': ?>
                <textarea rows="6" name="<?= $input_name ?>" <?= $required ?> style="resize: vertical;"></textarea>
                <?php break;

              case 'radiobuttons':
                foreach ($question->answers as $i => $opt):
                  $checked = $i === 0 ? 'checked' : ''; ?>
                  <label>
                    <input type="radio" name="<?= $input_name ?>" value="<?= esc_attr($opt['value']) ?>" <?= $required ?> <?= $checked ?>>
                    <span><?= esc_html($opt['value']) ?></span>
                  </label>
                  <?php endforeach;
                  if (!empty($question->other) && !empty($question->other->enabled)): 
                    $otherCheckboxId = 'other-toggle-' . $qid;
                    $otherInputWrapId = 'other-input-wrap-' . $qid;
                    $otherInputName   = $input_name . '_other';
                    ?>
                    <label for="<?= esc_attr($otherCheckboxId) ?>">
                      <input id="<?= esc_attr($otherCheckboxId) ?>" class="other-toggle" type="radio"
                        name="<?= $input_name ?>"
                        value="__other__"
                        <?= $is_required ? 'data-required="true"' : '' ?>
                        aria-controls="<?= esc_attr($otherInputWrapId) ?>" aria-expanded="false"
                        data-other-target="<?= esc_attr($otherInputWrapId) ?>"
                        data-other-input-name="<?= esc_attr($otherInputName) ?>"
                        data-question-name="<?= esc_attr($input_name) ?>">
                      <span>Other</span>
                    </label>

                    <div id="<?= esc_attr($otherInputWrapId) ?>" class="other-input-wrap">
                      <input type="text" name="<?= esc_attr($otherInputName) ?>" placeholder="Please specify"
                        aria-label="Other for <?= esc_attr($input_name) ?>">
                    </div>
                    <?php
                  endif;
                break;

              case 'checkboxes': ?>
                <div class="options-group" <?= $question->required ? "data-required-group='$input_name'" : '' ?>>
                  <?php foreach ($question->answers as $opt): ?>
                    <label>
                      <input type="checkbox" name="<?= $input_name ?>[]" value="<?= esc_attr($opt['value']) ?>" <?= $is_required ? 'data-required="true"' : '' ?>>
                      <span><?= esc_html($opt['value']) ?></span>
              
                    </label>

                  <?php endforeach; ?>

                  <?php if (!empty($question->other) && !empty($question->other->enabled)): ?>
                    <?php
                    $otherCheckboxId = 'other-toggle-' . $qid;
                    $otherInputWrapId = 'other-input-wrap-' . $qid;
                    $otherInputName   = $input_name . '_other';
                    ?>
                    <label for="<?= esc_attr($otherCheckboxId) ?>">
                      <input id="<?= esc_attr($otherCheckboxId) ?>" class="other-toggle" type="checkbox"
                        name="<?= $input_name ?>[]" value="__other__" <?= $is_required ? 'data-required="true"' : '' ?>
                        aria-controls="<?= esc_attr($otherInputWrapId) ?>" aria-expanded="false"
                        data-other-target="<?= esc_attr($otherInputWrapId) ?>"
                        data-other-input-name="<?= esc_attr($otherInputName) ?>"
                        data-question-name="<?= esc_attr($input_name) ?>">
                      <span>Other</span>
                    </label>

                    <div id="<?= esc_attr($otherInputWrapId) ?>" class="other-input-wrap">
                      <input type="text" name="<?= esc_attr($otherInputName) ?>" placeholder="Please specify"
                        aria-label="Other for <?= esc_attr($input_name) ?>">
                    </div>
                  <?php endif; ?>
                </div>
                <?php break;

              case 'date': ?>
                <input type="date" name="<?= $input_name ?>" <?= $required ?>>
                <?php break;

              case 'signature': ?>
                <div class="signature">
                  <canvas id="signature-pad" class="signature-pad" width="400" height="150" <?= $is_required ? 'data-required="true"' : '' ?>></canvas>
                  <button type="button" id="clear-signature" class="multi-form-button next-button signature-clear">Clear Signature</button>
                </div>
                <input type="hidden" name="signature_data" id="signature-data" <?= $required ?>>
                <?php break;

              default: ?>
                <input type="text" name="<?= $input_name ?>" <?= $required ?>>
            <?php endswitch; ?>
          </div>
        <?php endforeach; ?>
      </div>
    <?php endforeach; ?>

    <!-- Patient Step (always after sections) -->
    <div class="form-step is-hidden"
         data-step="<?= (int)$patientStepIndex ?>"
         <?= $hasEmbedStep ? '' : 'data-is-final="true"' ?>>

      <?php if ($useClinikoEmbed): ?>
        <h3>Confirm Your Details</h3>
        <p class="multi-form-title-color" style="margin-top:-6px;">
          Weâ€™ll use your email to match your booking. Please enter your Medicare number to confirm.
        </p>
      <?php else: ?>
        <h3>Patient Details</h3>
      <?php endif; ?>

      <div class="patient-grid">
        <?php
        // âœ… If it's Cliniko Embed: only Email + Medicare Number
        // âœ… Otherwise: keep the full patient details
        $fields = $useClinikoEmbed
          ? [
              ['email', 'Email', 'email', 12, true],
              ['medicare', 'Medicare Number', 'text', 8, true],
              ['medicare_reference_number', 'Medicare Reference', 'text', 4, true],
            ]
          : [
              ['first_name', 'First Name', 'text', 6, true],
              ['last_name', 'Last Name', 'text', 6, true],
              ['email', 'Email', 'email', 8, true],
              ['phone', 'Phone Number', 'text', 4, true],
              ['medicare', 'Medicare Number', 'text', 8, true],
              ['medicare_reference_number', 'Medicare Reference', 'text', 4, true],
              ['address_1', 'Address Line 1', 'text', 12, true],
              ['address_2', 'Address Line 2', 'text', 12, false],
              ['city', 'City', 'text', 6, true],
              ['state', 'State', 'text', 2, true],
              ['post_code', 'Post Code', 'text', 4, true],
              ['country', 'Country', 'text', 6, true],
              ['date_of_birth', 'Date of Birth', 'date', 6, true],
            ];

        foreach ($fields as [$name, $label_text, $type, $colSpan, $required]): ?>
          <div class="col-span-<?= (int)$colSpan ?> field-col">
            <label class="field-label" for="patient-<?= esc_attr($name) ?>">
              <?= esc_html($label_text) ?> <?= $required ? '<span class="req">*</span>' : '' ?>
            </label>
            <?php
            $attrs = [
              'id'            => "patient-$name",
              'type'          => $type,
              'name'          => "patient[$name]",
              'data-required' => $required ? 'true' : 'false',
            ];
            if ($required) $attrs['required'] = true;

            if ($name === 'medicare') {
              $attrs += [
                'inputmode'   => 'numeric',
                'maxlength'   => '13',
                'pattern'     => '\d{4}\s?\d{5}\s?\d',
                'title'       => 'Enter 10 digits (e.g. 1234 56789 1)',
                'placeholder' => '1234 56789 1',
              ];
            } elseif ($name === 'medicare_reference_number') {
              $attrs += [
                'inputmode'   => 'numeric',
                'maxlength'   => '1',
                'pattern'     => '\d',
                'title'       => 'Enter the 1-digit reference next to your name',
                'placeholder' => '1',
              ];
            }

            $attrString = '';
            foreach ($attrs as $k => $v) {
              $attrString .= ($v === true) ? " $k" : " $k=\"" . esc_attr($v) . "\"";
            }
            ?>
            <input<?= $attrString ?> />
          </div>
        <?php endforeach; ?>
      </div>
    </div>

    <!-- Cliniko Embed Step (ONLY if configured) â€“ always LAST -->
    <?php if ($hasEmbedStep && $embedSrc): ?>
      <div class="form-step is-hidden" data-step="<?= (int)$embedStepIndex ?>" data-is-final="true">
        <iframe
          id="cliniko-payment_iframe"
          src="<?= esc_url($embedSrc) ?>"
          frameborder="0"
          scrolling="none"
          width="100%"
          height="220"
          style="pointer-events: auto;"></iframe>
      </div>
    <?php endif; ?>
  </div>

  <div class="form-actions">
    <button type="button" id="step-prev" class="multi-form-button prev-button is-hidden">
      <?php if ($icon_prev && $icon_position === 'after'): ?><i class="<?= esc_attr($icon_prev) ?>"></i><?php endif; ?>
      <span>Back</span>
      <?php if ($icon_prev && $icon_position === 'before'): ?><i class="<?= esc_attr($icon_prev) ?>"></i><?php endif; ?>
    </button>

    <button type="button" id="step-next" class="multi-form-button next-button ">
      <?php if ($icon_next && $icon_position === 'before'): ?><i class="<?= esc_attr($icon_next) ?>"></i><?php endif; ?>
      <span>Next</span>
      <?php if ($icon_next && $icon_position === 'after'): ?><i class="<?= esc_attr($icon_next) ?>"></i><?php endif; ?>
    </button>
  </div>
</form>


<?php
// Use the same â€œthemeâ€ sources you already have in this template.
// Prefer the actual Elementor button control youâ€™re using (accent_color) if present.
$modal_brand  = esc_attr($settings['accent_color'] ?? $btn_bg);
$modal_font   = esc_attr($settings['font_family'] ?? $font);
$modal_text   = esc_attr($settings['form_text_color'] ?? $text);
$modal_title  = esc_attr($settings['titles_color'] ?? $titles_color);
$modal_border = esc_attr($settings['form_input_border_color'] ?? '#e2e8f0');

// modal radius: follow button radius (or fallback)
$modal_radius = esc_attr(($settings['form_button_border_radius']['size'] ?? 16) . ($settings['form_button_border_radius']['unit'] ?? 'px'));
?>

<style id="es-email-confirm-modal-style">
  /* hidden */
  #es-email-confirm-modal.is-hidden{ display:none !important; }

  /* theme tokens */
  #es-email-confirm-modal{
    --es-modal-font: <?= $modal_font ?>;
    --es-modal-brand: <?= $modal_brand ?>;
    --es-modal-text: <?= $modal_text ?>;
    --es-modal-title: <?= $modal_title ?>;
    --es-modal-border: <?= $modal_border ?>;
    --es-modal-radius: <?= $modal_radius ?>;
  }

  #es-email-confirm-modal{
    position:fixed; inset:0; z-index:999999;
    display:flex; align-items:center; justify-content:center;
    padding:16px;
    font-family: var(--es-modal-font);
  }
  #es-email-confirm-modal .es-email-modal__backdrop{
    position:absolute; inset:0;
    background:rgba(2,6,23,.62);
    backdrop-filter: blur(2px);
  }
  #es-email-confirm-modal .es-email-modal__dialog{
    position:relative;
    width:min(520px, 100%);
    background:#fff;
    border-radius: var(--es-modal-radius);
    box-shadow:0 18px 60px rgba(0,0,0,.25);
    padding:18px 18px 16px;
  }
  #es-email-confirm-modal .es-email-modal__title{
    margin:0 0 6px;
    font-size:18px;
    font-weight:700;
    color: var(--es-modal-title);
  }
  #es-email-confirm-modal .es-email-modal__text{
    margin:0 0 12px;
    font-size:14px;
    line-height:1.45;
    color: var(--es-modal-text);
  }
  #es-email-confirm-modal .es-email-modal__pill{
    display:flex; align-items:center; justify-content:space-center;
    gap:10px;
    border:1px solid var(--e-global-color-primary);
    background:#f8fafc;
    border-radius:12px;
    padding:10px 12px;
    margin:10px 0 14px;
  }
  #es-email-confirm-modal .es-email-modal__email{
    font-size:14px;
    color:#0f172a;
    font-weight:600;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  #es-email-confirm-modal .es-email-modal__actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }
  #es-email-confirm-modal .es-email-modal__btn{
    border:1px solid var(--e-global-color-primary);
    background:#fff;
    border-radius:10px;
    padding:10px 12px;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
  }
  #es-email-confirm-modal .es-email-modal__btn:hover{
    box-shadow: 2px 4px 12px 2px rgba(0,0,0,0.23);
-webkit-box-shadow: 2px 4px 12px 2px rgba(0,0,0,0.23);
-moz-box-shadow: 2px 4px 12px 2px rgba(0,0,0,0.23);
   }
  #es-email-confirm-modal .es-email-modal__btn--primary{
    border-color: transparent;
    background: var(--e-global-color-primary);
    color:#fff;
  }
  #es-email-confirm-modal .es-email-modal__btn--primary:hover{ filter:brightness(.97); }
  #es-email-confirm-modal .es-email-modal__btn--danger{
    border-color:#fecaca;
    background:#fff;
    color:#b91c1c;
  }
</style>


<div id="es-email-confirm-modal"
     class="es-email-modal is-hidden"
     aria-hidden="true"
     inert>
  <div class="es-email-modal__backdrop" data-es-close="1"></div>

  <div class="es-email-modal__dialog"
       role="dialog"
       aria-modal="true"
       aria-labelledby="es-email-modal-title"
       tabindex="-1">

    <div class="es-email-modal__header">
      <div>
        <h3 class="es-email-modal__title" id="es-email-modal-title">Important: use the same email</h3>
        <p class="es-email-modal__text">
          We match your booking detais to this form using your email address.
          Please make sure the email below is <strong>exactly the same</strong> in the next form.
        </p>
      </div>
    </div>

    <div class="es-email-modal__warn" role="note">
      <strong>If the email doesnâ€™t match,</strong> we may not be able to find your questionnaire automatically, which can delay your request.
    </div>

    <div class="es-email-modal__pill" aria-live="polite">
      <div class="es-email-modal__email" id="es-email-modal-email">â€”</div>
    </div>

    <div class="es-email-modal__actions">
      <button type="button" class="es-email-modal__btn es-email-modal__btn--danger" id="es-email-modal-edit">
        Change email
      </button>
      <button type="button" class="es-email-modal__btn es-email-modal__btn--primary" id="es-email-modal-ok">
        Iâ€™ll use this email
      </button>
    </div>

  </div>
</div>
